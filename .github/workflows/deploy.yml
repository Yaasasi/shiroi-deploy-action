name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build (ignore HASH_FILE)'
        required: false
        default: 'false'
  repository_dispatch:
    types: [trigger-workflow]

permissions: write-all

env:
  HASH_FILE: build_hash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    if: ${{ github.event.head_commit.message != 'Update hash file' }}
    outputs:
      hash_content: ${{ steps.read_hash.outputs.hash_content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Read HASH_FILE content
        id: read_hash
        run: |
          content=""
          if [ -f "${{ env.HASH_FILE }}" ]; then
            content=$(cat "${{ env.HASH_FILE }}" || true)
          fi
          echo "hash_content=$content" >> $GITHUB_OUTPUT

  check:
    name: Check need cancel
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      canceled: ${{ steps.decide.outputs.canceled }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide to cancel
        id: decide
        shell: bash
        env:
          HASH_CONTENT: ${{ needs.prepare.outputs.hash_content }}
          FORCE_BUILD_INPUT: ${{ github.event.inputs.force }}
        run: |
          set -e
          # FORCE_BUILD 开关：workflow_dispatch: force=true 时强制构建
          if [ "${FORCE_BUILD_INPUT}" = "true" ]; then
            echo "canceled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          # 也支持仓库变量强制构建（Settings → Variables）
          if [ "${{ vars.FORCE_BUILD }}" = "true" ]; then
            echo "canceled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          CURRENT_SHA_SHORT=$(git rev-parse --short HEAD)
          # 仅当 HASH_FILE 存在且值等于当前短 SHA 才取消
          if [ -n "${HASH_CONTENT}" ] && [ "${HASH_CONTENT}" = "${CURRENT_SHA_SHORT}" ]; then
            echo "canceled=true" >> $GITHUB_OUTPUT
          else
            echo "canceled=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build artifact
    runs-on: ubuntu-latest
    needs: check
    if: ${{ needs.check.outputs.canceled != 'true' }}
    strategy:
      matrix:
        node-version: [lts/*]
    outputs:
      sha_short: ${{ steps.meta.outputs.sha_short }}
      branch: ${{ steps.meta.outputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: innei-dev/shiroi
          ref: main
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - uses: jongwooo/next-cache@v1

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: |
          sh ./ci-release-build.sh

      - name: Store commit metadata
        id: meta
        shell: bash
        run: |
          sha_short=$(git rev-parse --short HEAD)
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          echo "sha_short=$sha_short" >> "$GITHUB_OUTPUT"
          echo "branch=$branch_name" >> "$GITHUB_OUTPUT"

      - name: Upload build artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: shiroi-${{ steps.meta.outputs.sha_short }}
          path: assets/release.zip
          if-no-files-found: error
          retention-days: 30

      - name: Cache Build Artifacts (optional)
        id: cache-primes
        uses: actions/cache/save@v4
        with:
          path: assets
          key: ${{ github.run_number }}-release

  deploy:
    name: Deploy artifact (remote)
    runs-on: ubuntu-latest
    needs: build
    # 通过仓库变量启用：Settings → Variables → ENABLE_REMOTE_DEPLOY='true'
    if: ${{ vars.ENABLE_REMOTE_DEPLOY == 'true' }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: shiroi-${{ needs.build.outputs.sha_short }}
          path: .

      - name: Ensure release.zip present
        run: |
          test -f release.zip || mv assets/release.zip release.zip || echo 'release.zip already at root'

      - name: copy file via ssh password
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: 'release.zip'
          target: '/tmp/shiro'

      - name: Exec deploy script with SSH
        uses: appleboy/ssh-action@master
        with:
          command_timeout: 5m
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script_stop: true
          script: |
            set -euxo pipefail
            basedir=/home/${{ secrets.USER }}/www/shiro
            workdir=/tmp/shiro
            mkdir -p $basedir $workdir
            cd $workdir
            unzip -o release.zip
            if [ -f $basedir/ecosystem.config.js ]; then
              cp $basedir/ecosystem.config.js $workdir/standalone/ecosystem.config.js
            else
              cp $workdir/standalone/ecosystem.config.js $basedir/ecosystem.config.js
            fi
            ln -sf $workdir/standalone/server.js $basedir/server.js
            mkdir -p $workdir/standalone/.next
            rm -rf $workdir/standalone/.next/cache
            ln -sf $basedir/.cache $workdir/standalone/.next/cache
            cd $basedir
            pm2 reload ecosystem.config.js --update-env
            rm $workdir/release.zip
            pm2 save
            echo "Deployed successfully"

  store:
    name: Store artifact commit version
    runs-on: ubuntu-latest
    needs: build
    if: ${{ always() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update HASH_FILE
        env:
          SHA_SHORT: ${{ needs.build.outputs.sha_short }}
        run: echo $SHA_SHORT > ${{ env.HASH_FILE }}
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.HASH_FILE }}
          git commit -a -m "Update hash file" || echo "no changes"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
