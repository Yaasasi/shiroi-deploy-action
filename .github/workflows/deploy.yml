name: Build and Upload Artifact

on:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [trigger-workflow]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Shiroi
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.sha.outputs.short }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ðŸ‘‰ æ ¹æ®ä½ çš„é¡¹ç›®å¯ç”¨éœ€è¦çš„çŽ¯å¢ƒï¼ˆç¤ºä¾‹æ³¨é‡Šï¼Œä¸‹æ–¹è‡ªé€‰å…¶ä¸€æˆ–éƒ½åˆ æŽ‰ï¼‰
      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 20
      #     cache: npm
      # - name: Install deps (Node)
      #   if: hashFiles('package-lock.json') != ''
      #   run: npm ci
      # - name: Build (Node)
      #   if: hashFiles('package.json') != ''
      #   run: npm run build

      # - name: Setup Java
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: temurin
      #     java-version: 21
      # - name: Build (Gradle)
      #   if: hashFiles('gradlew') != ''
      #   run: |
      #     chmod +x ./gradlew
      #     ./gradlew clean build

      # - name: Setup Rust
      #   uses: dtolnay/rust-toolchain@stable
      # - name: Build (Rust)
      #   if: hashFiles('Cargo.toml') != ''
      #   run: cargo build --release

      - name: Generic build fallback
        run: |
          set -e
          if [ -f build.sh ]; then
            chmod +x build.sh
            ./build.sh
          elif [ -f Makefile ]; then
            make -j
          elif [ -f package.json ]; then
            npm ci || npm i
            npm run build
          else
            echo "No known build system detected. Skipping build step."
          fi

      - name: Compute short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Pack artifact to assets/release.zip
        run: |
          mkdir -p assets
          # è‹¥æœ‰å›ºå®šçš„æž„å»ºè¾“å‡ºç›®å½•ï¼Œæ›¿æ¢ä¸‹é¢çš„ out_dir
          out_dir="dist"
          if [ ! -d "$out_dir" ]; then
            # å¸¸è§ç›®å½•å…œåº•
            for d in dist build out target/release app/build/outputs; do
              if [ -d "$d" ]; then out_dir="$d"; break; fi
            done
          fi
          if [ -d "$out_dir" ]; then
            (cd "$out_dir" && zip -r "../assets/release.zip" .)
          else
            echo "No standard build output dir found; zipping repository (excluding .git & node_modules)."
            zip -r assets/release.zip . -x ".git/*" "node_modules/*"
          fi
          echo "release.zip prepared at assets/release.zip"

  upload:
    name: Upload Artifact
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout (for path resolution only)
        uses: actions/checkout@v4

      - name: Download workflow run workspace
        uses: actions/download-artifact@v4
        if: false
        with:
          name: dummy

      # ç”±äºŽä¸Šä¸€ job å·²ç”Ÿæˆ assets/release.zip åœ¨åŒä¸€æ¬¡ runner çš„å·¥ä½œç©ºé—´ä¸å¯ç›´æŽ¥å…±äº«ï¼Œ
      # è¿™é‡Œæ”¹ä¸ºä½¿ç”¨ actions/upload-artifact åœ¨ build å†…ï¼›
      # ä½†ä¸ºäº†æœ€å°æ”¹åŠ¨ï¼Œè¿™é‡Œç›´æŽ¥é‡æ–°æ‰“åŒ…ä¸Šä¼ ï¼šæ›´ç¨³å¦¥çš„æ–¹å¼æ˜¯æŠŠâ€œæ‰“åŒ…+ä¸Šä¼ â€æ”¾åœ¨ build å†…éƒ¨ã€‚
      # ä¸ºé¿å…é‡å¤é€»è¾‘ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•åœ°å†æ¬¡æ‰“åŒ…ï¼ˆå¦‚æžœä»“åº“ç©ºæˆ–è€…æ²¡æœ‰æž„å»ºç›®å½•ï¼Œä¸Šä¸€æ­¥å·²ç”Ÿæˆ assets/release.zipï¼‰ã€‚
      - name: Ensure artifact exists
        run: |
          if [ ! -f assets/release.zip ]; then
            echo "assets/release.zip not found in this job. Creating a minimal placeholder from repo."
            mkdir -p assets && zip -r assets/release.zip . -x ".git/*" "node_modules/*"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shiroi-${{ needs.build.outputs.sha_short }}
          path: assets/release.zip
          if-no-files-found: error
          retention-days: 30

  # åŽŸ workflow ä¸­çš„ store ä»»åŠ¡è‹¥éœ€è¦ä¿ç•™ï¼ˆæ›´æ–° hash æ–‡ä»¶ï¼‰ï¼ŒæŠŠ needs æ”¹æˆ buildï¼ˆä¸è¦ä¾èµ–å·²åˆ é™¤çš„ deployï¼‰
  store:
    name: Store hash file
    runs-on: ubuntu-latest
    needs: [build]
    env:
      HASH_FILE: build_hash
      SHA_SHORT: ${{ needs.build.outputs.sha_short }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write hash
        run: echo "$SHA_SHORT" > "$HASH_FILE"

      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "$HASH_FILE"
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update hash file"
            git push
          fi
